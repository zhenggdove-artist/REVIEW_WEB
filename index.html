<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DrawMeTaiwan - 溫柔視線行動</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @font-face { font-family: 'ChenYuluoyan'; src: url('./fonts/ChenYuluoyan-Thin.ttf') format('truetype'); font-display: swap; }
    @font-face { font-family: 'GarmentDistrict'; src: url('./fonts/GarmentDistrict-Regular.otf') format('opentype'); font-display: swap; }
    @font-face { font-family: 'Streetwear'; src: url('./fonts/Streetwear.otf') format('opentype'); font-display: swap; }
    @font-face { font-family: 'GamaHand'; src: url('./fonts/GamaHand.otf') format('opentype'); font-display: swap; }
    body { background-color: #fcfcfc; background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png'); color: #1a1a1a; margin: 0; padding: 0; overflow-x: hidden; }
    .sketch-border { border: 2px solid #1a1a1a; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; }
    .sketch-shadow { box-shadow: 6px 6px 0px 0px rgba(0,0,0,0.8); }
    .admin-highlight { outline: 3px dashed #FF00A0 !important; outline-offset: 4px; cursor: pointer; }
    .admin-highlight:hover { background: rgba(255,0,160,0.1); }
    .sidebar { width: 380px; background: #fff; border-left: 3px solid #000; height: 100vh; position: fixed; right: 0; top: 0; z-index: 2000; box-shadow: -10px 0 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; }
    .sidebar.open { transform: translateX(0); }
    .content-area { transition: margin-right 0.3s ease; }
    .admin-mode .content-area { margin-right: 380px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .admin-btn { width: 25px; height: 25px; border-radius: 50%; background: #888; border: none; cursor: pointer; transition: all 0.3s; opacity: 0.5; }
    .admin-btn:hover { opacity: 1; transform: scale(1.2); }
    .rich-editor { border: 2px solid #000; border-radius: 4px; min-height: 120px; padding: 12px; outline: none; background: #fff; }
    .rich-editor:focus { border-color: #FF00A0; }
    .toolbar-btn { padding: 6px 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 12px; border-radius: 3px; }
    .toolbar-btn:hover { background: #f0f0f0; }
    .toolbar-btn:active { background: #ddd; }
    /* 自適應內容的白色底框 */
    .media-container { display: inline-block; background: white; padding: 24px; max-width: 100%; }
    .content-box { display: inline-block; background: white; padding: 32px 48px; max-width: 90%; word-wrap: break-word; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ============ 可用字體列表 ============
    const AVAILABLE_FONTS = [
      { id: 'GarmentDistrict', name: 'Garment District' },
      { id: 'Streetwear', name: 'Streetwear' },
      { id: 'GamaHand', name: 'Gama Hand' },
      { id: 'ChenYuluoyan', name: '辰宇落雁體' }
    ];

    // ============ 初始數據 ============
    const INITIAL_DATA = {
      settings: { englishFont: 'GarmentDistrict' },
      background: { color: '#fcfcfc', image: 'https://www.transparenttextures.com/patterns/handmade-paper.png' },
      decoration: {
        circleImage: { id: 'deco-circle', type: 'image', content: 'https://picsum.photos/seed/circle/400/400', style: { rotation: 12 } },
        leftAnimation: { id: 'left-animation', content: '', width: 200, height: 300, posX: 30, posY: 50 }
      },
      // 各區塊框線樣式
      boxStyles: {
        mediaBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: '#ffffff', shadowColor: 'rgba(0,0,0,0.8)' },
        manifestoBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: 'rgba(255,255,255,0.5)', shadowColor: 'rgba(0,0,0,0.8)' },
        actionBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: '#ffffff', shadowColor: 'rgba(0,0,0,0.8)' },
        locationsBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: '#FFF8E7', shadowColor: 'rgba(0,0,0,0.8)' },
        supportersBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: '#E7F0FF', shadowColor: 'rgba(0,0,0,0.8)' },
        footerBox: { borderColor: '#1a1a1a', borderWidth: 2, bgColor: '#FF00A0', shadowColor: 'rgba(0,0,0,0.8)' },
        dashedBorder: { color: '#000000', width: 4, dashLength: 10, gapLength: 6 }
      },
      // Instagram 連結
      instagramLink: 'https://www.instagram.com/gg_dove/',
      hero: {
        title: { id: 'hero-title', type: 'richtext', content: 'DRAW ME TAIWAN', displayMode: 'text', imageUrl: '', imageWidth: 400, imageHeight: 0, style: { fontSize: 'text-7xl', color: '#FF00A0', rotation: -2 } },
        subtitle: { id: 'hero-subtitle', type: 'richtext', content: '溫柔視線行動 - 讓我們重新練習『看見』人。', displayMode: 'text', imageUrl: '', imageWidth: 300, imageHeight: 0, style: { fontSize: 'text-2xl', color: '#000000', rotation: 1 } },
        mediaItems: [
          { id: 'hero-media-0', type: 'media', content: 'https://picsum.photos/seed/drawme/800/800', mediaType: 'image' }
        ],
        currentMediaIndex: 0
      },
      manifesto: {
        paragraphs: [
          { id: 'p1', type: 'richtext', content: '最近搭捷運時，你是否也感覺到了那股緊繃？身為一個藝術家看到整個台灣社會，開始草木皆兵的狀態相當難受。', style: { fontSize: 'text-xl', color: '#000000', rotation: 0 } },
          { id: 'p2', type: 'richtext', content: '我希望人們開始尋找的不是敵人，而是有趣的經歷與朋友、夥伴。', style: { fontSize: 'text-xl', color: '#000000', rotation: 0.5 } },
          { id: 'p3', type: 'richtext', content: '這不是繪畫比賽，這是一個整體社會關於「看見」的重新練習。當我們願意花 5 分鐘去觀察一個陌生人，我們就無法再把對方視為冰冷的「威脅」。', style: { fontSize: 'text-xl', color: '#000000', rotation: -0.5 } }
        ]
      },
      actions: {
        title: { id: 'actions-title', type: 'richtext', content: '如何參與？', displayMode: 'text', imageUrl: '', imageWidth: 250, imageHeight: 0, style: { fontSize: 'text-4xl', color: '#000000', rotation: 1 } },
        items: [
          { id: 'a1', type: 'richtext', content: '索取胸章：我將自費製作並發送，索取地點整理於此。', style: { fontSize: 'text-lg', color: '#000000', rotation: 0 } },
          { id: 'a2', type: 'richtext', content: '自行列印：我無償公開圖檔，歡迎自行下載列印。', style: { fontSize: 'text-lg', color: '#000000', rotation: 1 } },
          { id: 'a3', type: 'richtext', content: '開始觀察：放下手機，拿起筆。上傳 Tag #DrawMeTaiwan。', style: { fontSize: 'text-lg', color: '#000000', rotation: -1 } }
        ]
      },
      locations: {
        title: { id: 'locations-title', type: 'richtext', content: '索取徽章地點', displayMode: 'text', imageUrl: '', imageWidth: 250, imageHeight: 0, style: { fontSize: 'text-4xl', color: '#000000', rotation: -1 } },
        items: [
          { id: 'loc1', name: '台北車站', address: '台北市中正區北平西路3號', note: '12/28 快閃活動現場' },
          { id: 'loc2', name: '某某咖啡廳', address: '台北市大安區...', note: '營業時間內可索取' },
          { id: 'loc3', name: '某某書店', address: '台北市信義區...', note: '數量有限' }
        ]
      },
      supporters: {
        title: { id: 'supporters-title', type: 'richtext', content: '贊助廠商 / 參與藝術家', displayMode: 'text', imageUrl: '', imageWidth: 300, imageHeight: 0, style: { fontSize: 'text-4xl', color: '#000000', rotation: 1 } },
        sponsors: [
          { id: 'sp1', name: '贊助商名稱', logo: 'https://picsum.photos/seed/sponsor1/200/100', url: '' },
          { id: 'sp2', name: '贊助商名稱2', logo: 'https://picsum.photos/seed/sponsor2/200/100', url: '' }
        ],
        artists: [
          { id: 'art1', name: 'GGdove', avatar: 'https://picsum.photos/seed/artist1/100/100', url: 'https://www.instagram.com/gg_dove/' },
          { id: 'art2', name: '藝術家名稱', avatar: 'https://picsum.photos/seed/artist2/100/100', url: '' }
        ]
      },
      footer: {
        contact: { id: 'footer-contact', type: 'richtext', content: '12/28 週日 台北車站快閃行動，聯絡 GGdove 參與。', style: { fontSize: 'text-lg', color: '#FFFFFF', rotation: 0 } }
      }
    };

    // ============ 狀態管理 ============
    let siteData = JSON.parse(localStorage.getItem('drawme_data_v14')) || JSON.parse(JSON.stringify(INITIAL_DATA));
    // 補充左側動畫區域
    if (!siteData.decoration?.leftAnimation) {
      siteData.decoration.leftAnimation = JSON.parse(JSON.stringify(INITIAL_DATA.decoration.leftAnimation));
    }
    if (!siteData.decoration) siteData.decoration = JSON.parse(JSON.stringify(INITIAL_DATA.decoration));
    if (!siteData.settings) siteData.settings = JSON.parse(JSON.stringify(INITIAL_DATA.settings));
    if (!siteData.boxStyles) siteData.boxStyles = JSON.parse(JSON.stringify(INITIAL_DATA.boxStyles));
    // 補充缺少的 shadowColor 和新區塊樣式
    ['mediaBox', 'manifestoBox', 'actionBox', 'locationsBox', 'supportersBox', 'footerBox'].forEach(key => {
      if (!siteData.boxStyles[key]) {
        siteData.boxStyles[key] = JSON.parse(JSON.stringify(INITIAL_DATA.boxStyles[key]));
      } else if (!siteData.boxStyles[key].shadowColor) {
        siteData.boxStyles[key].shadowColor = 'rgba(0,0,0,0.8)';
      }
    });
    if (!siteData.instagramLink) siteData.instagramLink = INITIAL_DATA.instagramLink;
    // 新增地點和贊助者區塊
    if (!siteData.locations) siteData.locations = JSON.parse(JSON.stringify(INITIAL_DATA.locations));
    if (!siteData.supporters) siteData.supporters = JSON.parse(JSON.stringify(INITIAL_DATA.supporters));
    // 舊版資料遷移：mainMedia -> mediaItems
    if (siteData.hero.mainMedia && !siteData.hero.mediaItems) {
      siteData.hero.mediaItems = [siteData.hero.mainMedia];
      siteData.hero.currentMediaIndex = 0;
      delete siteData.hero.mainMedia;
    }
    if (!siteData.hero.mediaItems) siteData.hero.mediaItems = JSON.parse(JSON.stringify(INITIAL_DATA.hero.mediaItems));
    if (siteData.hero.currentMediaIndex === undefined) siteData.hero.currentMediaIndex = 0;
    let isAdmin = false;
    let activeElementId = null;
    let savedSelection = null; // 保存選取範圍

    function saveData() {
      localStorage.setItem('drawme_data_v14', JSON.stringify(siteData));
      applyStyles();
      render();
    }

    function updateInstagramLink(url) {
      siteData.instagramLink = url;
      saveData();
    }

    // ============ 地點管理 ============
    function addLocation() {
      const newId = 'loc-' + Date.now();
      siteData.locations.items.push({ id: newId, name: '新地點', address: '地址...', note: '備註...' });
      saveData();
    }

    function updateLocation(index, field, value) {
      siteData.locations.items[index][field] = value;
      saveData();
    }

    function removeLocation(index) {
      if (siteData.locations.items.length > 1) {
        siteData.locations.items.splice(index, 1);
        saveData();
      } else {
        alert('至少需要保留一個地點！');
      }
    }

    // ============ 贊助商管理 ============
    function addSponsor() {
      const newId = 'sp-' + Date.now();
      siteData.supporters.sponsors.push({ id: newId, name: '贊助商名稱', logo: 'https://picsum.photos/seed/' + Date.now() + '/200/100', url: '' });
      saveData();
    }

    function updateSponsor(index, field, value) {
      siteData.supporters.sponsors[index][field] = value;
      saveData();
    }

    function removeSponsor(index) {
      siteData.supporters.sponsors.splice(index, 1);
      saveData();
    }

    // ============ 藝術家管理 ============
    function addArtist() {
      const newId = 'art-' + Date.now();
      siteData.supporters.artists.push({ id: newId, name: '藝術家名稱', avatar: 'https://picsum.photos/seed/' + Date.now() + '/100/100', url: '' });
      saveData();
    }

    function updateArtist(index, field, value) {
      siteData.supporters.artists[index][field] = value;
      saveData();
    }

    function removeArtist(index) {
      siteData.supporters.artists.splice(index, 1);
      saveData();
    }

    function applyStyles() {
      const bg = siteData.background || INITIAL_DATA.background;
      const font = siteData.settings?.englishFont || 'GarmentDistrict';
      document.body.style.backgroundColor = bg.color;
      document.body.style.backgroundImage = bg.image ? `url('${bg.image}')` : 'none';
      document.body.style.fontFamily = `'${font}', 'ChenYuluoyan', sans-serif`;
    }

    function findElement(id, obj = siteData) {
      if (!obj || typeof obj !== 'object') return null;
      if (obj.id === id) return obj;
      for (const key of Object.keys(obj)) {
        const found = findElement(id, obj[key]);
        if (found) return found;
      }
      return null;
    }

    function updateElement(id, updates) {
      const el = findElement(id);
      if (el) {
        Object.assign(el, updates);
        if (updates.style) el.style = { ...el.style, ...updates.style };
        saveData();
      }
    }

    function updateBackground(updates) {
      siteData.background = { ...siteData.background, ...updates };
      saveData();
    }

    function updateSettings(updates) {
      siteData.settings = { ...siteData.settings, ...updates };
      saveData();
    }

    function updateBoxStyle(boxName, updates) {
      if (!siteData.boxStyles) siteData.boxStyles = {};
      siteData.boxStyles[boxName] = { ...siteData.boxStyles[boxName], ...updates };
      saveData();
    }

    // ============ 輪播功能 ============
    function nextMedia() {
      const items = siteData.hero.mediaItems;
      if (items.length > 1) {
        siteData.hero.currentMediaIndex = (siteData.hero.currentMediaIndex + 1) % items.length;
        saveData();
      }
    }

    function prevMedia() {
      const items = siteData.hero.mediaItems;
      if (items.length > 1) {
        siteData.hero.currentMediaIndex = (siteData.hero.currentMediaIndex - 1 + items.length) % items.length;
        saveData();
      }
    }

    function addMediaItem() {
      const newId = 'hero-media-' + Date.now();
      siteData.hero.mediaItems.push({
        id: newId,
        type: 'media',
        content: 'https://picsum.photos/seed/' + Date.now() + '/800/800',
        mediaType: 'image'
      });
      saveData();
    }

    function removeMediaItem(index) {
      if (siteData.hero.mediaItems.length > 1) {
        siteData.hero.mediaItems.splice(index, 1);
        if (siteData.hero.currentMediaIndex >= siteData.hero.mediaItems.length) {
          siteData.hero.currentMediaIndex = siteData.hero.mediaItems.length - 1;
        }
        saveData();
      } else {
        alert('至少需要保留一張圖片！');
      }
    }

    function updateMediaItem(index, url) {
      siteData.hero.mediaItems[index].content = url;
      saveData();
    }

    // ============ 選取範圍保存/恢復 ============
    function saveSelection() {
      const sel = window.getSelection();
      if (sel.rangeCount > 0) {
        savedSelection = sel.getRangeAt(0).cloneRange();
      }
    }

    function restoreSelection() {
      if (savedSelection) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
      }
    }

    // ============ 導出/導入功能 ============
    function exportData() {
      const dataStr = JSON.stringify(siteData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'site-data.json';
      a.click();
      URL.revokeObjectURL(url);
      alert('設定已導出！\n\n更新網站步驟：\n1. 用文字編輯器打開 index.html\n2. 找到 INITIAL_DATA = {...}\n3. 用導出的 JSON 內容替換\n4. 提交並推送到 GitHub');
    }

    function copyDataToClipboard() {
      const dataStr = JSON.stringify(siteData, null, 2);
      navigator.clipboard.writeText(dataStr).then(() => {
        alert('設定已複製到剪貼板！\n\n更新網站步驟：\n1. 用文字編輯器打開 index.html\n2. 找到 const INITIAL_DATA = {...};\n3. 用複製的內容替換 {...} 部分\n4. 儲存檔案\n5. git add . && git commit -m "更新內容" && git push');
      });
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            siteData = data;
            saveData();
            alert('設定已導入！');
          } catch (err) {
            alert('檔案格式錯誤！');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // ============ YouTube 解析 ============
    function getYouTubeId(url) {
      if (!url) return null;
      const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    // ============ 渲染函數 ============
    function renderMedia(el, extraClass = '') {
      if (!el) return '';
      const adminClass = isAdmin ? 'admin-highlight' : '';
      const activeClass = activeElementId === el.id ? 'ring-4 ring-pink-500' : '';
      const rotation = el.style?.rotation ? `transform: rotate(${el.style.rotation}deg);` : '';
      const onClick = isAdmin ? `onclick="selectElement('${el.id}')"` : '';

      const youtubeId = getYouTubeId(el.content);
      if (youtubeId) {
        return `<div class="${adminClass} ${activeClass} ${extraClass}" style="${rotation}" ${onClick}>
          <iframe width="100%" height="450" src="https://www.youtube.com/embed/${youtubeId}" frameborder="0" allowfullscreen class="rounded"></iframe>
        </div>`;
      }
      if (el.content && (el.content.includes('.mp4') || el.content.includes('.webm'))) {
        return `<video src="${el.content}" controls class="max-w-full h-auto rounded ${adminClass} ${activeClass} ${extraClass}" style="${rotation}" ${onClick}></video>`;
      }
      return `<img src="${el.content}" alt="圖片" class="max-w-full h-auto rounded ${adminClass} ${activeClass} ${extraClass}" style="${rotation}" ${onClick}>`;
    }

    function renderElement(el, extraClass = '') {
      if (!el) return '';
      const adminClass = isAdmin ? 'admin-highlight' : '';
      const activeClass = activeElementId === el.id ? 'ring-4 ring-pink-500' : '';
      const rotation = el.style?.rotation ? `transform: rotate(${el.style.rotation}deg);` : '';
      const color = el.style?.color ? `color: ${el.style.color};` : '';
      const onClick = isAdmin ? `onclick="selectElement('${el.id}')"` : '';

      if (el.type === 'media') return renderMedia(el, extraClass);
      if (el.type === 'image') {
        return `<img src="${el.content}" alt="圖片" class="max-w-full h-auto rounded ${adminClass} ${activeClass} ${extraClass}" style="${rotation}" ${onClick}>`;
      }
      // 支援圖片模式的標題
      if (el.displayMode === 'image' && el.imageUrl) {
        const imgWidth = el.imageWidth ? `width: ${el.imageWidth}px;` : '';
        const imgHeight = el.imageHeight ? `height: ${el.imageHeight}px;` : '';
        const imgStyle = imgWidth || imgHeight ? `style="${imgWidth} ${imgHeight} object-contain;"` : 'class="max-h-32 md:max-h-48 object-contain"';
        return `<div class="${adminClass} ${activeClass} ${extraClass}" style="${rotation}" ${onClick}>
          <img src="${el.imageUrl}" alt="${el.content}" class="mx-auto" ${imgWidth || imgHeight ? `style="${imgWidth} ${imgHeight} object-contain;"` : 'style="max-height: 12rem; object-fit: contain;"'}>
        </div>`;
      }
      return `<div class="${el.style?.fontSize || ''} ${adminClass} ${activeClass} ${extraClass}" style="${rotation} ${color}" ${onClick}>${el.content}</div>`;
    }

    function renderSidebar() {
      if (!isAdmin) return '';

      if (activeElementId === 'background-settings') {
        const bg = siteData.background || {};
        const currentFont = siteData.settings?.englishFont || 'GarmentDistrict';
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">網站設定</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">英文字體</h4>
                <select class="w-full p-2 border-2 border-black rounded" onchange="updateSettings({englishFont: this.value})">
                  ${AVAILABLE_FONTS.map(f => `<option value="${f.id}" ${currentFont === f.id ? 'selected' : ''} style="font-family: '${f.id}'">${f.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <h4 class="font-bold mb-2 text-sm">背景顏色</h4>
                <input type="color" value="${bg.color || '#fcfcfc'}" class="w-full h-10 cursor-pointer" onchange="updateBackground({color: this.value})">
              </div>
              <div>
                <h4 class="font-bold mb-2 text-sm">背景圖片網址</h4>
                <input type="text" value="${bg.image || ''}" class="w-full p-2 border-2 border-black rounded text-sm" placeholder="輸入圖片網址或留空" onchange="updateBackground({image: this.value})">
              </div>
              <button onclick="updateBackground({image: ''})" class="w-full py-2 border-2 border-black rounded hover:bg-gray-100 text-sm">清除背景圖片</button>
              <div class="border-t pt-4 mt-4">
                <h4 class="font-bold mb-2 text-sm">儲存設定到網站</h4>
                <p class="text-xs text-gray-500 mb-2">目前的修改只存在你的瀏覽器。要讓所有人看到，請導出設定並更新 GitHub。</p>
                <button onclick="copyDataToClipboard()" class="w-full py-2 bg-blue-500 text-white rounded font-bold hover:bg-blue-600 text-sm mb-2">複製設定到剪貼板</button>
                <button onclick="exportData()" class="w-full py-2 border-2 border-black rounded hover:bg-gray-100 text-sm mb-2">下載設定檔 (JSON)</button>
                <button onclick="importData()" class="w-full py-2 border-2 border-black rounded hover:bg-gray-100 text-sm">導入設定檔</button>
              </div>
            </div>
            <div class="p-4 border-t-2 border-black">
              <button onclick="if(confirm('確定要重置所有內容嗎？')){localStorage.removeItem('drawme_data_v14');location.reload();}" class="w-full py-2 bg-red-500 text-white rounded-full font-bold hover:bg-red-600 text-sm">重置所有內容</button>
            </div>
          </div>
        `;
      }

      // 輪播圖片管理
      if (activeElementId === 'carousel-settings') {
        const items = siteData.hero.mediaItems || [];
        const boxStyle = siteData.boxStyles?.mediaBox || INITIAL_DATA.boxStyles.mediaBox;
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">輪播圖片管理</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">圖片框樣式</h4>
                <div class="space-y-2">
                  <div>
                    <label class="text-xs">框線顏色</label>
                    <input type="color" value="${boxStyle.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('mediaBox', {borderColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">框線粗細: ${boxStyle.borderWidth}px</label>
                    <input type="range" min="0" max="10" value="${boxStyle.borderWidth}" class="w-full" onchange="updateBoxStyle('mediaBox', {borderWidth: parseInt(this.value)})">
                  </div>
                  <div>
                    <label class="text-xs">背景顏色</label>
                    <input type="color" value="${boxStyle.bgColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('mediaBox', {bgColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">陰影顏色</label>
                    <input type="text" value="${boxStyle.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="例: rgba(0,0,0,0.8)" onchange="updateBoxStyle('mediaBox', {shadowColor: this.value})">
                  </div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-2">
                  <h4 class="font-bold text-sm">圖片列表 (${items.length}張)</h4>
                  <button onclick="addMediaItem()" class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">+ 新增</button>
                </div>
                <div class="space-y-3 max-h-[400px] overflow-y-auto">
                  ${items.map((item, idx) => `
                    <div class="border-2 border-gray-300 rounded p-2 ${siteData.hero.currentMediaIndex === idx ? 'border-pink-500 bg-pink-50' : ''}">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold">#${idx + 1}</span>
                        <button onclick="removeMediaItem(${idx})" class="text-red-500 hover:text-red-700 text-xs">刪除</button>
                      </div>
                      <input type="text" value="${item.content}" class="w-full p-1 border border-gray-300 rounded text-xs mb-2" placeholder="圖片或影片網址" onchange="updateMediaItem(${idx}, this.value)">
                      ${getYouTubeId(item.content) ?
                        `<div class="text-xs text-gray-500">YouTube 影片</div>` :
                        `<img src="${item.content}" class="w-full h-20 object-cover rounded">`
                      }
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // 虛線框設定
      if (activeElementId === 'box-dashed') {
        const db = siteData.boxStyles?.dashedBorder || INITIAL_DATA.boxStyles.dashedBorder;
        const fs = siteData.boxStyles?.footerBox || INITIAL_DATA.boxStyles.footerBox;
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">底部區域設定</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">虛線框樣式</h4>
                <div class="space-y-2">
                  <div>
                    <label class="text-xs">虛線顏色</label>
                    <input type="color" value="${db.color}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('dashedBorder', {color: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">虛線粗細: ${db.width}px</label>
                    <input type="range" min="1" max="20" value="${db.width}" class="w-full" onchange="updateBoxStyle('dashedBorder', {width: parseInt(this.value)})">
                  </div>
                  <div>
                    <label class="text-xs">虛線長度: ${db.dashLength}px</label>
                    <input type="range" min="2" max="50" value="${db.dashLength}" class="w-full" onchange="updateBoxStyle('dashedBorder', {dashLength: parseInt(this.value)})">
                  </div>
                  <div>
                    <label class="text-xs">間隔長度: ${db.gapLength}px</label>
                    <input type="range" min="2" max="50" value="${db.gapLength}" class="w-full" onchange="updateBoxStyle('dashedBorder', {gapLength: parseInt(this.value)})">
                  </div>
                </div>
              </div>
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">聯絡框樣式</h4>
                <div class="space-y-2">
                  <div>
                    <label class="text-xs">框線顏色</label>
                    <input type="color" value="${fs.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('footerBox', {borderColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">框線粗細: ${fs.borderWidth}px</label>
                    <input type="range" min="0" max="10" value="${fs.borderWidth}" class="w-full" onchange="updateBoxStyle('footerBox', {borderWidth: parseInt(this.value)})">
                  </div>
                  <div>
                    <label class="text-xs">背景顏色</label>
                    <input type="color" value="${fs.bgColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('footerBox', {bgColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">陰影顏色</label>
                    <input type="text" value="${fs.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="例: rgba(0,0,0,0.8)" onchange="updateBoxStyle('footerBox', {shadowColor: this.value})">
                  </div>
                </div>
              </div>
              <div>
                <h4 class="font-bold mb-2 text-sm">Instagram 連結</h4>
                <input type="text" value="${siteData.instagramLink || ''}" class="w-full p-2 border border-gray-300 rounded text-xs" placeholder="https://www.instagram.com/yourname/" onchange="updateInstagramLink(this.value)">
                <p class="text-xs text-gray-400 mt-1">點擊聯絡框會開啟此連結</p>
              </div>
            </div>
          </div>
        `;
      }

      // 宣言區塊框設定
      if (activeElementId === 'box-manifesto') {
        const ms = siteData.boxStyles?.manifestoBox || INITIAL_DATA.boxStyles.manifestoBox;
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">宣言區塊設定</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div>
                <label class="text-xs">框線顏色</label>
                <input type="color" value="${ms.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('manifestoBox', {borderColor: this.value})">
              </div>
              <div>
                <label class="text-xs">框線粗細: ${ms.borderWidth}px</label>
                <input type="range" min="0" max="10" value="${ms.borderWidth}" class="w-full" onchange="updateBoxStyle('manifestoBox', {borderWidth: parseInt(this.value)})">
              </div>
              <div>
                <label class="text-xs">背景顏色</label>
                <input type="text" value="${ms.bgColor}" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="例: rgba(255,255,255,0.5)" onchange="updateBoxStyle('manifestoBox', {bgColor: this.value})">
                <p class="text-xs text-gray-400 mt-1">支援 rgba 透明色，例: rgba(255,255,255,0.5)</p>
              </div>
              <div>
                <label class="text-xs">陰影顏色</label>
                <input type="text" value="${ms.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="例: rgba(0,0,0,0.8)" onchange="updateBoxStyle('manifestoBox', {shadowColor: this.value})">
              </div>
            </div>
          </div>
        `;
      }

      // 行動區塊框設定
      if (activeElementId === 'box-action') {
        const as = siteData.boxStyles?.actionBox || INITIAL_DATA.boxStyles.actionBox;
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">行動區塊設定</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div>
                <label class="text-xs">框線顏色</label>
                <input type="color" value="${as.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('actionBox', {borderColor: this.value})">
              </div>
              <div>
                <label class="text-xs">框線粗細: ${as.borderWidth}px</label>
                <input type="range" min="0" max="10" value="${as.borderWidth}" class="w-full" onchange="updateBoxStyle('actionBox', {borderWidth: parseInt(this.value)})">
              </div>
              <div>
                <label class="text-xs">背景顏色</label>
                <input type="color" value="${as.bgColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('actionBox', {bgColor: this.value})">
              </div>
              <div>
                <label class="text-xs">陰影顏色</label>
                <input type="text" value="${as.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="例: rgba(0,0,0,0.8)" onchange="updateBoxStyle('actionBox', {shadowColor: this.value})">
              </div>
            </div>
          </div>
        `;
      }

      // 索取徽章地點設定
      if (activeElementId === 'locations-settings') {
        const ls = siteData.boxStyles?.locationsBox || INITIAL_DATA.boxStyles.locationsBox;
        const locations = siteData.locations?.items || [];
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">索取徽章地點</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">區塊樣式</h4>
                <div class="space-y-2">
                  <div>
                    <label class="text-xs">框線顏色</label>
                    <input type="color" value="${ls.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('locationsBox', {borderColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">背景顏色</label>
                    <input type="color" value="${ls.bgColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('locationsBox', {bgColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">陰影顏色</label>
                    <input type="text" value="${ls.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" onchange="updateBoxStyle('locationsBox', {shadowColor: this.value})">
                  </div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-2">
                  <h4 class="font-bold text-sm">地點列表 (${locations.length}個)</h4>
                  <button onclick="addLocation()" class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">+ 新增</button>
                </div>
                <div class="space-y-3 max-h-[350px] overflow-y-auto">
                  ${locations.map((loc, idx) => `
                    <div class="border-2 border-gray-300 rounded p-2">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold">#${idx + 1}</span>
                        <button onclick="removeLocation(${idx})" class="text-red-500 hover:text-red-700 text-xs">刪除</button>
                      </div>
                      <input type="text" value="${loc.name}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="地點名稱" onchange="updateLocation(${idx}, 'name', this.value)">
                      <input type="text" value="${loc.address}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="地址" onchange="updateLocation(${idx}, 'address', this.value)">
                      <input type="text" value="${loc.note}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="備註" onchange="updateLocation(${idx}, 'note', this.value)">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // 贊助廠商/藝術家設定
      if (activeElementId === 'supporters-settings') {
        const ss = siteData.boxStyles?.supportersBox || INITIAL_DATA.boxStyles.supportersBox;
        const sponsors = siteData.supporters?.sponsors || [];
        const artists = siteData.supporters?.artists || [];
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">贊助商/藝術家</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div class="border-b pb-4">
                <h4 class="font-bold mb-2 text-sm">區塊樣式</h4>
                <div class="space-y-2">
                  <div>
                    <label class="text-xs">框線顏色</label>
                    <input type="color" value="${ss.borderColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('supportersBox', {borderColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">背景顏色</label>
                    <input type="color" value="${ss.bgColor}" class="w-full h-8 cursor-pointer" onchange="updateBoxStyle('supportersBox', {bgColor: this.value})">
                  </div>
                  <div>
                    <label class="text-xs">陰影顏色</label>
                    <input type="text" value="${ss.shadowColor || 'rgba(0,0,0,0.8)'}" class="w-full p-1 border border-gray-300 rounded text-xs" onchange="updateBoxStyle('supportersBox', {shadowColor: this.value})">
                  </div>
                </div>
              </div>

              <div class="border-b pb-4">
                <div class="flex justify-between items-center mb-2">
                  <h4 class="font-bold text-sm">贊助廠商 (${sponsors.length}個)</h4>
                  <button onclick="addSponsor()" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">+ 新增</button>
                </div>
                <div class="space-y-2 max-h-[150px] overflow-y-auto">
                  ${sponsors.map((sp, idx) => `
                    <div class="border border-gray-300 rounded p-2">
                      <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold">#${idx + 1}</span>
                        <button onclick="removeSponsor(${idx})" class="text-red-500 hover:text-red-700 text-xs">刪除</button>
                      </div>
                      <input type="text" value="${sp.name}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="名稱" onchange="updateSponsor(${idx}, 'name', this.value)">
                      <input type="text" value="${sp.logo}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="Logo 圖片網址" onchange="updateSponsor(${idx}, 'logo', this.value)">
                      <input type="text" value="${sp.url || ''}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="連結網址" onchange="updateSponsor(${idx}, 'url', this.value)">
                    </div>
                  `).join('')}
                </div>
              </div>

              <div>
                <div class="flex justify-between items-center mb-2">
                  <h4 class="font-bold text-sm">參與藝術家 (${artists.length}個)</h4>
                  <button onclick="addArtist()" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">+ 新增</button>
                </div>
                <div class="space-y-2 max-h-[150px] overflow-y-auto">
                  ${artists.map((art, idx) => `
                    <div class="border border-gray-300 rounded p-2">
                      <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold">#${idx + 1}</span>
                        <button onclick="removeArtist(${idx})" class="text-red-500 hover:text-red-700 text-xs">刪除</button>
                      </div>
                      <input type="text" value="${art.name}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="名稱" onchange="updateArtist(${idx}, 'name', this.value)">
                      <input type="text" value="${art.avatar}" class="w-full p-1 border border-gray-300 rounded text-xs mb-1" placeholder="頭像圖片網址" onchange="updateArtist(${idx}, 'avatar', this.value)">
                      <input type="text" value="${art.url || ''}" class="w-full p-1 border border-gray-300 rounded text-xs" placeholder="連結網址 (IG/網站)" onchange="updateArtist(${idx}, 'url', this.value)">
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // 左側動畫設定
      if (activeElementId === 'left-animation') {
        const leftAnim = siteData.decoration?.leftAnimation || {};
        return `
          <div class="sidebar open">
            <div class="p-4 border-b-2 border-black flex justify-between items-center">
              <h3 class="text-lg font-bold">左側動畫設定</h3>
              <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
              <div>
                <label class="block text-sm font-bold mb-2">動畫/圖片網址</label>
                <input type="text" value="${leftAnim.content || ''}" class="w-full p-2 border-2 border-black rounded text-sm" placeholder="輸入 GIF、影片或圖片網址" onchange="siteData.decoration.leftAnimation.content = this.value; saveData();">
                <p class="text-xs text-gray-400 mt-1">支援 GIF、MP4、WebM 或圖片</p>
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">寬度: ${leftAnim.width || 200}px</label>
                <input type="range" min="100" max="400" value="${leftAnim.width || 200}" class="w-full" onchange="siteData.decoration.leftAnimation.width = parseInt(this.value); saveData();">
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">高度: ${leftAnim.height || 300}px</label>
                <input type="range" min="100" max="600" value="${leftAnim.height || 300}" class="w-full" onchange="siteData.decoration.leftAnimation.height = parseInt(this.value); saveData();">
              </div>
              <div class="border-t pt-4 mt-4">
                <h4 class="font-bold mb-3 text-sm">位置調整</h4>
                <div>
                  <label class="block text-sm font-bold mb-2">水平位置 (X): ${leftAnim.posX ?? 30}px</label>
                  <input type="range" min="-500" max="1500" value="${leftAnim.posX ?? 30}" class="w-full" onchange="siteData.decoration.leftAnimation.posX = parseInt(this.value); saveData();">
                  <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>-500</span>
                    <span>0</span>
                    <span>750</span>
                    <span>1500</span>
                  </div>
                </div>
                <div class="mt-4">
                  <label class="block text-sm font-bold mb-2">垂直位置 (Y): ${leftAnim.posY ?? 50}%</label>
                  <input type="range" min="0" max="100" value="${leftAnim.posY ?? 50}" class="w-full" onchange="siteData.decoration.leftAnimation.posY = parseInt(this.value); saveData();">
                  <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>上 0%</span>
                    <span>中 50%</span>
                    <span>下 100%</span>
                  </div>
                </div>
              </div>
              ${leftAnim.content ? `
                <div>
                  <div class="text-sm text-gray-500 mb-1">預覽：</div>
                  ${leftAnim.content.includes('.mp4') || leftAnim.content.includes('.webm') ?
                    `<video src="${leftAnim.content}" autoplay loop muted playsinline class="w-full max-h-48 object-contain border-2 border-gray-300 rounded"></video>` :
                    `<img src="${leftAnim.content}" class="w-full max-h-48 object-contain border-2 border-gray-300 rounded">`
                  }
                </div>
              ` : ''}
              <div class="p-3 bg-blue-50 border border-blue-300 rounded text-xs">
                <strong>提示：</strong>留空則不顯示左側區域。動畫區域會固定在網頁左側中央位置。
              </div>
              ${leftAnim.content ? `
                <button onclick="siteData.decoration.leftAnimation.content = ''; saveData();" class="w-full py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600 text-sm">清除動畫</button>
              ` : ''}
            </div>
          </div>
        `;
      }

      if (!activeElementId) return '';
      const el = findElement(activeElementId);
      if (!el) return '';

      const isMedia = el.type === 'media' || el.id === 'hero-media';
      const isImage = el.type === 'image';
      const isText = el.type === 'richtext' || el.type === 'text';

      return `
        <div class="sidebar open">
          <div class="p-4 border-b-2 border-black flex justify-between items-center">
            <h3 class="text-lg font-bold">編輯元素</h3>
            <button onclick="activeElementId=null;render();" class="text-2xl hover:text-pink-500">&times;</button>
          </div>
          <div class="p-4 space-y-4 overflow-y-auto flex-1">
            ${isText ? `
              <!-- 顯示模式切換 -->
              <div class="border-b pb-4 mb-4">
                <label class="block text-sm font-bold mb-2">顯示模式</label>
                <div class="flex gap-2">
                  <button class="flex-1 py-2 rounded ${el.displayMode !== 'image' ? 'bg-black text-white' : 'bg-gray-200'}" onclick="updateElement('${el.id}', {displayMode: 'text'})">文字</button>
                  <button class="flex-1 py-2 rounded ${el.displayMode === 'image' ? 'bg-black text-white' : 'bg-gray-200'}" onclick="updateElement('${el.id}', {displayMode: 'image'})">圖片</button>
                </div>
              </div>

              ${el.displayMode === 'image' ? `
                <!-- 圖片模式 -->
                <div>
                  <label class="block text-sm font-bold mb-2">圖片網址</label>
                  <input type="text" value="${el.imageUrl || ''}" class="w-full p-2 border-2 border-black rounded text-sm" placeholder="輸入手寫標題圖片網址" onchange="updateElement('${el.id}', {imageUrl: this.value})">
                  <p class="text-xs text-gray-400 mt-1">可上傳手寫文字圖片來替代文字標題</p>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs font-bold mb-1">寬度: ${el.imageWidth || 0}px</label>
                    <input type="range" min="0" max="800" value="${el.imageWidth || 0}" class="w-full" onchange="updateElement('${el.id}', {imageWidth: parseInt(this.value)})">
                    <p class="text-xs text-gray-400">0 = 自動</p>
                  </div>
                  <div>
                    <label class="block text-xs font-bold mb-1">高度: ${el.imageHeight || 0}px</label>
                    <input type="range" min="0" max="400" value="${el.imageHeight || 0}" class="w-full" onchange="updateElement('${el.id}', {imageHeight: parseInt(this.value)})">
                    <p class="text-xs text-gray-400">0 = 自動</p>
                  </div>
                </div>
                ${el.imageUrl ? `
                  <div class="mt-3">
                    <div class="text-sm text-gray-500 mb-1">預覽：</div>
                    <img src="${el.imageUrl}" class="object-contain border-2 border-gray-300 rounded p-2 bg-white" style="${el.imageWidth ? 'width:' + el.imageWidth + 'px;' : 'max-height: 8rem;'} ${el.imageHeight ? 'height:' + el.imageHeight + 'px;' : ''}">
                  </div>
                ` : ''}
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded text-xs">
                  <strong>提示：</strong>文字內容仍會保留，切換回文字模式時會顯示。
                </div>
              ` : `
                <!-- 文字模式 -->
                <div>
                  <label class="block text-sm font-bold mb-2">內容編輯</label>
                  <p class="text-xs text-gray-500 mb-2">先選取文字，再點下方按鈕套用樣式</p>
                  <div class="flex gap-1 mb-2 flex-wrap bg-gray-100 p-2 rounded">
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFormat('bold')" title="粗體"><b>B</b></button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFormat('italic')" title="斜體"><i>I</i></button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFormat('underline')" title="底線"><u>U</u></button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFontSizeCmd('1')" title="極小字">1</button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFontSizeCmd('3')" title="小字">3</button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFontSizeCmd('5')" title="大字">5</button>
                    <button class="toolbar-btn" onmousedown="event.preventDefault();applyFontSizeCmd('7')" title="巨大">7</button>
                  </div>
                  <div class="flex gap-1 mb-2 flex-wrap bg-gray-100 p-2 rounded">
                    ${AVAILABLE_FONTS.map(f => `
                      <button class="toolbar-btn text-xs" onmousedown="event.preventDefault();applyFontNameCmd('${f.id}')" title="${f.name}" style="font-family:'${f.id}'">${f.name.substring(0,4)}</button>
                    `).join('')}
                  </div>
                  <div class="flex gap-2 mb-2 items-center bg-gray-100 p-2 rounded">
                    <span class="text-xs">選取文字顏色:</span>
                    <input type="color" id="text-color-picker" value="#000000" class="w-8 h-8 cursor-pointer border-0" onchange="applyFontColorCmd(this.value)">
                  </div>
                  <div id="rich-editor" class="rich-editor" contenteditable="true"
                       onmouseup="saveSelection()"
                       onkeyup="saveSelection()"
                       onblur="saveRichText('${el.id}')">${el.content}</div>
                </div>
                <div>
                  <label class="block text-sm font-bold mb-2">整體文字顏色</label>
                  <input type="color" value="${el.style?.color || '#000000'}" class="w-full h-10 cursor-pointer" onchange="updateElement('${el.id}', {style: {color: this.value}})">
                </div>
                <div>
                  <label class="block text-sm font-bold mb-2">整體字體大小</label>
                  <select class="w-full p-2 border-2 border-black rounded" onchange="updateElement('${el.id}', {style: {fontSize: this.value}})">
                    <option value="text-sm" ${el.style?.fontSize === 'text-sm' ? 'selected' : ''}>小</option>
                    <option value="text-lg" ${el.style?.fontSize === 'text-lg' ? 'selected' : ''}>中</option>
                    <option value="text-xl" ${el.style?.fontSize === 'text-xl' ? 'selected' : ''}>大</option>
                    <option value="text-2xl" ${el.style?.fontSize === 'text-2xl' ? 'selected' : ''}>特大</option>
                    <option value="text-4xl" ${el.style?.fontSize === 'text-4xl' ? 'selected' : ''}>超大</option>
                    <option value="text-7xl" ${el.style?.fontSize === 'text-7xl' ? 'selected' : ''}>巨大</option>
                  </select>
                </div>
              `}
            ` : isMedia ? `
              <div>
                <label class="block text-sm font-bold mb-2">媒體網址</label>
                <input type="text" value="${el.content}" class="w-full p-2 border-2 border-black rounded text-sm" placeholder="圖片網址 或 YouTube 網址" onchange="updateElement('${el.id}', {content: this.value})">
                <p class="text-xs text-gray-400 mt-1">支援：圖片網址、YouTube 連結</p>
              </div>
              <div class="text-sm text-gray-500">預覽：</div>
              ${getYouTubeId(el.content) ?
                `<iframe width="100%" height="150" src="https://www.youtube.com/embed/${getYouTubeId(el.content)}" frameborder="0" class="rounded border-2 border-black"></iframe>` :
                `<img src="${el.content}" class="w-full rounded border-2 border-black">`
              }
            ` : `
              <div>
                <label class="block text-sm font-bold mb-2">圖片網址</label>
                <input type="text" value="${el.content}" class="w-full p-2 border-2 border-black rounded" onchange="updateElement('${el.id}', {content: this.value})">
              </div>
              <div class="text-sm text-gray-500">預覽：</div>
              <img src="${el.content}" class="w-full rounded border-2 border-black">
            `}
            <div>
              <label class="block text-sm font-bold mb-2">旋轉角度: ${el.style?.rotation || 0}°</label>
              <input type="range" min="-10" max="10" step="0.5" value="${el.style?.rotation || 0}" class="w-full" onchange="updateElement('${el.id}', {style: {rotation: parseFloat(this.value)}})">
            </div>
          </div>
        </div>
      `;
    }

    // ============ 富文本編輯功能（修正版）============
    function applyFormat(cmd) {
      restoreSelection();
      document.execCommand(cmd, false, null);
      saveSelection();
    }

    function applyFontSizeCmd(size) {
      restoreSelection();
      document.execCommand('fontSize', false, size);
      saveSelection();
    }

    function applyFontNameCmd(font) {
      restoreSelection();
      document.execCommand('fontName', false, font);
      saveSelection();
    }

    function applyFontColorCmd(color) {
      restoreSelection();
      document.execCommand('foreColor', false, color);
      saveSelection();
    }

    function saveRichText(id) {
      const editor = document.getElementById('rich-editor');
      if (editor) {
        const el = findElement(id);
        if (el) {
          el.content = editor.innerHTML;
          localStorage.setItem('drawme_data_v14', JSON.stringify(siteData));
        }
      }
    }

    // ============ 輪播渲染 ============
    function renderCarousel() {
      const items = siteData.hero.mediaItems || [];
      const currentIndex = siteData.hero.currentMediaIndex || 0;
      const currentItem = items[currentIndex];
      if (!currentItem) return '';

      const boxStyle = siteData.boxStyles?.mediaBox || INITIAL_DATA.boxStyles.mediaBox;
      const borderStyle = `border: ${boxStyle.borderWidth}px solid ${boxStyle.borderColor};`;
      const bgStyle = `background: ${boxStyle.bgColor};`;
      const shadowStyle = `box-shadow: 6px 6px 0px 0px ${boxStyle.shadowColor || 'rgba(0,0,0,0.8)'};`;

      const youtubeId = getYouTubeId(currentItem.content);
      let mediaContent = '';
      if (youtubeId) {
        mediaContent = `<iframe width="100%" height="450" src="https://www.youtube.com/embed/${youtubeId}" frameborder="0" allowfullscreen class="rounded"></iframe>`;
      } else if (currentItem.content && (currentItem.content.includes('.mp4') || currentItem.content.includes('.webm'))) {
        mediaContent = `<video src="${currentItem.content}" controls class="max-w-full h-auto rounded"></video>`;
      } else {
        mediaContent = `<img src="${currentItem.content}" alt="圖片" class="max-w-full h-auto rounded">`;
      }

      const showNav = items.length > 1;
      return `
        <div class="media-container relative cursor-pointer"
             style="${borderStyle} ${bgStyle} ${shadowStyle} border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; transform: rotate(1deg);"
             onclick="${isAdmin ? '' : 'nextMedia()'}">
          ${mediaContent}
          ${showNav ? `
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
              ${items.map((_, idx) => `
                <span class="w-3 h-3 rounded-full ${idx === currentIndex ? 'bg-pink-500' : 'bg-gray-400'} inline-block"></span>
              `).join('')}
            </div>
            ${!isAdmin ? `
              <div class="absolute inset-0 flex items-center justify-between px-4 opacity-0 hover:opacity-100 transition-opacity">
                <button onclick="event.stopPropagation();prevMedia()" class="w-10 h-10 bg-black/50 text-white rounded-full text-xl hover:bg-black/70">&lt;</button>
                <button onclick="event.stopPropagation();nextMedia()" class="w-10 h-10 bg-black/50 text-white rounded-full text-xl hover:bg-black/70">&gt;</button>
              </div>
            ` : ''}
          ` : ''}
          ${isAdmin ? `<div class="absolute inset-0 admin-highlight" onclick="selectElement('carousel-settings')"></div>` : ''}
        </div>
      `;
    }

    function renderLoginModal() {
      return `
        <div class="modal-bg" id="login-modal" style="display:none;">
          <form onsubmit="handleLogin(event)" class="bg-white sketch-border sketch-shadow p-10 max-w-sm w-full space-y-6" style="transform: rotate(1deg);">
            <div class="text-center">
              <h2 class="text-3xl font-bold mb-2">後台登入</h2>
              <p class="text-sm opacity-60">請輸入管理密碼以開啟編輯模式</p>
            </div>
            <input type="password" id="password-input" placeholder="請輸入密碼..." class="w-full p-4 border-2 border-black rounded text-center text-xl outline-none focus:ring-4 focus:ring-yellow-200">
            <div class="flex gap-4">
              <button type="submit" class="flex-1 bg-black text-white py-3 rounded-full font-bold hover:bg-gray-800">進入</button>
              <button type="button" onclick="hideLoginModal()" class="flex-1 border-2 border-black py-3 rounded-full font-bold hover:bg-gray-100">取消</button>
            </div>
          </form>
        </div>
      `;
    }

    function render() {
      const d = siteData;
      document.getElementById('app').innerHTML = `
        <div class="${isAdmin ? 'admin-mode' : ''} min-h-screen relative">
          <div class="fixed bottom-4 right-4 z-[2100] flex flex-col gap-2">
            ${!isAdmin ? `
              <button onclick="showLoginModal()" class="admin-btn" title="後台管理"></button>
            ` : `
              <button onclick="selectElement('background-settings')" class="admin-btn" style="background: #4CAF50;" title="網站設定"></button>
              <button onclick="exitAdmin()" class="admin-btn" style="background: #333;" title="退出編輯"></button>
            `}
          </div>

          ${renderLoginModal()}
          ${renderSidebar()}

          <main class="content-area max-w-4xl mx-auto py-24 px-8">
            <div class="text-center mb-24">
              ${renderElement(d.hero.title, 'mb-8')}
              ${renderElement(d.hero.subtitle, 'mb-16')}
              ${renderCarousel()}
            </div>

            ${(() => {
              const ms = siteData.boxStyles?.manifestoBox || INITIAL_DATA.boxStyles.manifestoBox;
              const msShadow = `box-shadow: 6px 6px 0px 0px ${ms.shadowColor || 'rgba(0,0,0,0.8)'};`;
              return `
                <div class="p-12 mb-24 relative space-y-8 shadow-inner ${isAdmin ? 'admin-highlight' : ''}"
                     style="background: ${ms.bgColor}; border: ${ms.borderWidth}px solid ${ms.borderColor}; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; ${msShadow}"
                     ${isAdmin ? 'onclick="selectElement(\'box-manifesto\')"' : ''}>
                  <div class="absolute -top-10 left-0 text-9xl opacity-10 select-none">"</div>
                  ${d.manifesto.paragraphs.map(p => renderElement(p)).join('')}
                  <div class="absolute -bottom-20 right-0 text-9xl opacity-10 select-none" style="transform: rotate(180deg);">"</div>
                </div>
              `;
            })()}

            <div class="mb-24">
              ${renderElement(d.actions.title, 'text-center mb-16')}
              <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                ${(() => {
                  const as = siteData.boxStyles?.actionBox || INITIAL_DATA.boxStyles.actionBox;
                  const asShadow = `box-shadow: 6px 6px 0px 0px ${as.shadowColor || 'rgba(0,0,0,0.8)'};`;
                  return d.actions.items.map((item, idx) => `
                    <div class="p-8 ${isAdmin ? 'admin-highlight' : ''}"
                         style="background: ${as.bgColor}; border: ${as.borderWidth}px solid ${as.borderColor}; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; transform: rotate(${idx % 2 === 0 ? 1 : -1}deg); ${asShadow}"
                         ${isAdmin ? 'onclick="event.stopPropagation();selectElement(\'box-action\')"' : ''}>
                      ${renderElement(item)}
                    </div>
                  `).join('');
                })()}
              </div>
            </div>

            <!-- 索取徽章地點 -->
            ${(() => {
              const ls = siteData.boxStyles?.locationsBox || INITIAL_DATA.boxStyles.locationsBox;
              const lsShadow = `box-shadow: 6px 6px 0px 0px ${ls.shadowColor || 'rgba(0,0,0,0.8)'};`;
              const locations = siteData.locations?.items || [];
              return `
                <div class="mb-24">
                  ${renderElement(d.locations?.title || siteData.locations?.title, 'text-center mb-12')}
                  <div class="p-8 ${isAdmin ? 'admin-highlight' : ''}"
                       style="background: ${ls.bgColor}; border: ${ls.borderWidth}px solid ${ls.borderColor}; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; ${lsShadow}"
                       ${isAdmin ? 'onclick="selectElement(\'locations-settings\')"' : ''}>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      ${locations.map((loc, idx) => `
                        <div class="p-4 bg-white/80 rounded-lg" style="transform: rotate(${idx % 2 === 0 ? 0.5 : -0.5}deg);">
                          <div class="font-bold text-lg mb-1">${loc.name}</div>
                          <div class="text-sm text-gray-600 mb-1">${loc.address}</div>
                          <div class="text-xs text-pink-600">${loc.note}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              `;
            })()}

            <!-- 贊助廠商 / 參與藝術家 -->
            ${(() => {
              const ss = siteData.boxStyles?.supportersBox || INITIAL_DATA.boxStyles.supportersBox;
              const ssShadow = `box-shadow: 6px 6px 0px 0px ${ss.shadowColor || 'rgba(0,0,0,0.8)'};`;
              const sponsors = siteData.supporters?.sponsors || [];
              const artists = siteData.supporters?.artists || [];
              return `
                <div class="mb-24">
                  ${renderElement(d.supporters?.title || siteData.supporters?.title, 'text-center mb-12')}
                  <div class="p-8 ${isAdmin ? 'admin-highlight' : ''}"
                       style="background: ${ss.bgColor}; border: ${ss.borderWidth}px solid ${ss.borderColor}; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; ${ssShadow}"
                       ${isAdmin ? 'onclick="selectElement(\'supporters-settings\')"' : ''}>

                    ${sponsors.length > 0 ? `
                      <div class="mb-8">
                        <h4 class="text-center text-lg font-bold mb-4 opacity-60">贊助廠商</h4>
                        <div class="flex flex-wrap justify-center gap-6">
                          ${sponsors.map(sp => `
                            <a href="${sp.url || '#'}" target="_blank" rel="noopener noreferrer" class="block hover:scale-110 transition-transform">
                              <img src="${sp.logo}" alt="${sp.name}" class="h-16 object-contain" title="${sp.name}">
                            </a>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}

                    ${artists.length > 0 ? `
                      <div>
                        <h4 class="text-center text-lg font-bold mb-4 opacity-60">參與藝術家</h4>
                        <div class="flex flex-wrap justify-center gap-6">
                          ${artists.map(art => `
                            <a href="${art.url || '#'}" target="_blank" rel="noopener noreferrer" class="text-center hover:scale-110 transition-transform">
                              <img src="${art.avatar}" alt="${art.name}" class="w-16 h-16 rounded-full object-cover mx-auto mb-2 border-2 border-black">
                              <div class="text-sm font-bold">${art.name}</div>
                            </a>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            })()}

            ${(() => {
              const db = siteData.boxStyles?.dashedBorder || INITIAL_DATA.boxStyles.dashedBorder;
              const fs = siteData.boxStyles?.footerBox || INITIAL_DATA.boxStyles.footerBox;
              const fsShadow = `box-shadow: 6px 6px 0px 0px ${fs.shadowColor || 'rgba(0,0,0,0.8)'};`;
              const igLink = siteData.instagramLink || '';
              return `
                <div class="text-center pt-24 ${isAdmin ? 'admin-highlight' : ''}" style="border-top: ${db.width}px dashed ${db.color};" ${isAdmin ? 'onclick="selectElement(\'box-dashed\')"' : ''}>
                  <a href="${igLink}" target="_blank" rel="noopener noreferrer" class="content-box text-white inline-block cursor-pointer hover:scale-105 transition-transform"
                       style="background: ${fs.bgColor}; border: ${fs.borderWidth}px solid ${fs.borderColor}; border-radius: 255px 15px 225px 15px/15px 225px 15px 255px; transform: rotate(1deg); ${fsShadow} text-decoration: none;">
                    ${renderElement(d.footer.contact)}
                  </a>
              `;
            })()}
              <div class="mt-16 flex justify-center gap-6 text-xl opacity-60">
                <span>#DrawMeTaiwan</span>
                <span>#社會雕塑</span>
                <span>#溫柔視線行動</span>
              </div>
            </div>
          </main>

          <div class="fixed inset-0 pointer-events-none -z-20 opacity-20">
            <div class="absolute bottom-40 left-10 w-60 h-2 border-b-2 border-black" style="transform: rotate(-6deg);"></div>
          </div>

          <!-- 左側動畫區域 -->
          ${(() => {
            const leftAnim = siteData.decoration?.leftAnimation;
            const hasContent = leftAnim?.content;
            if (!hasContent && !isAdmin) return '';
            const posX = leftAnim?.posX ?? 30;
            const posY = leftAnim?.posY ?? 50;
            return `
              <div class="fixed z-10 ${isAdmin ? 'pointer-events-auto' : 'pointer-events-none'}"
                   style="left: ${posX}px; top: ${posY}%;">
                <div
                  class="${isAdmin ? 'admin-highlight cursor-pointer' : ''} ${activeElementId === 'left-animation' ? 'ring-4 ring-pink-500' : ''}"
                  style="width: ${leftAnim?.width || 200}px; height: ${leftAnim?.height || 300}px; transform: translateY(-50%);"
                  ${isAdmin ? 'onclick="selectElement(\'left-animation\')"' : ''}
                >
                  ${hasContent ?
                    (leftAnim.content.includes('.mp4') || leftAnim.content.includes('.webm') ?
                      `<video src="${leftAnim.content}" autoplay loop muted playsinline class="w-full h-full object-contain"></video>` :
                      `<img src="${leftAnim.content}" class="w-full h-full object-contain" alt="動畫">`) :
                    `<div class="w-full h-full border-2 border-dashed border-gray-400 rounded flex items-center justify-center text-gray-400 text-sm text-center p-4 bg-gray-50/50">
                      點擊設定<br>背景圖片
                    </div>`
                  }
                </div>
              </div>
            `;
          })()}

          <div class="fixed top-20 right-20 z-10 ${isAdmin ? 'pointer-events-auto' : 'pointer-events-none'}">
            <div
              class="w-40 h-40 rounded-full overflow-hidden border-2 border-black opacity-30 hover:opacity-60 transition-opacity ${isAdmin ? 'admin-highlight cursor-pointer' : ''} ${activeElementId === 'deco-circle' ? 'ring-4 ring-pink-500' : ''}"
              style="transform: rotate(${d.decoration?.circleImage?.style?.rotation || 12}deg);"
              ${isAdmin ? 'onclick="selectElement(\'deco-circle\')"' : ''}
            >
              ${d.decoration?.circleImage?.content ?
                `<img src="${d.decoration.circleImage.content}" class="w-full h-full object-cover" alt="裝飾圖片">` :
                `<div class="w-full h-full bg-gray-300"></div>`
              }
            </div>
          </div>
        </div>
      `;
    }

    function showLoginModal() {
      document.getElementById('login-modal').style.display = 'flex';
      document.getElementById('password-input').focus();
    }

    function hideLoginModal() {
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('password-input').value = '';
    }

    function handleLogin(e) {
      e.preventDefault();
      if (document.getElementById('password-input').value === 'drawme') {
        isAdmin = true;
        hideLoginModal();
        render();
      } else {
        alert('密碼錯誤！');
      }
    }

    function exitAdmin() {
      isAdmin = false;
      activeElementId = null;
      render();
    }

    function selectElement(id) {
      activeElementId = id;
      render();
    }

    applyStyles();
    render();
  </script>
</body>
</html>
